<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Sky Odyssey</title>

  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/png" href="skyico.png" />
  <link rel="apple-touch-icon" href="skyico.png" />
  <meta name="theme-color" content="#000510" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="mobile-web-app-capable" content="yes" />

  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js"></script>

  <style>
    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      background: #000;
      overflow: hidden;
      touch-action: manipulation;
      font-family: "Segoe UI", sans-serif;
    }

    /* SCÈNE EN PLEIN ÉCRAN (IMPORTANT) */
    a-scene {
      position: fixed !important;
      inset: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      z-index: 1;
    }
    canvas { z-index: 1; }

    /* UI AU-DESSUS */
    #ui-layer {
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      z-index: 9999;
      padding: 20px;
      box-sizing: border-box;
      background: linear-gradient(to bottom, rgba(0, 5, 15, 0.95), transparent);
      color: #00ffcc;
      pointer-events: auto;
    }

    #distance-hud {
      position: fixed;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 20, 40, 0.9);
      border: 2px solid #00ffcc;
      padding: 20px;
      border-radius: 12px;
      color: #fff;
      text-align: center;
      min-width: 280px;
      display: none;
      z-index: 10000;
      box-shadow: 0 0 20px rgba(0, 255, 204, 0.3);
      pointer-events: none;
      box-sizing: border-box;
    }

    .dist-val {
      font-size: 1.6em;
      color: #00ffcc;
      font-weight: bold;
      display: block;
      margin: 5px 0;
    }

    #pos-info {
      font-family: monospace;
      font-size: 11px;
      color: #88ccff;
      opacity: 0.9;
    }

    select, button {
      background: #001a2b;
      color: #00ffcc;
      border: 1px solid #00ffcc;
      padding: 10px 12px;
      border-radius: 6px;
      font-size: 14px;
      outline: none;
      transition: all 0.2s ease;
    }

    button:active { transform: scale(0.98); }

    button.success {
      background: #00ffcc;
      color: #001a2b;
      border-color: #fff;
      font-weight: bold;
    }
  </style>
</head>

<body>
  <div id="ui-layer">
    <strong style="letter-spacing: 2px;">SKY ODYSSEY</strong><br />
    <span id="pos-info">Synchronisation GPS...</span>
    <br /><br />
    <div style="display:flex; gap:12px; flex-wrap:wrap;">
      <select id="target-select">
        <option value="">-- Sélectionner Cible --</option>
        <optgroup label="Système Solaire" id="planets-list"></optgroup>
        <optgroup label="Étoiles Majeures" id="stars-list"></optgroup>
      </select>
      <button id="btn-calibrate">Calibrer Gyro</button>
    </div>
  </div>

  <div id="distance-hud">
    <span id="hud-name" style="text-transform: uppercase; letter-spacing: 2px; font-size: 0.85em; opacity: 0.9;">Objet</span>
    <div class="dist-val" id="hud-dist">--</div>
    <span id="hud-unit" style="font-size: 0.8em; color: #88ccff;">unité</span>
  </div>

  <a-scene vr-mode-ui="enabled:false" embedded renderer="antialias:true">
    <a-entity id="camera-rig">
      <a-entity
        id="camera"
        camera="near:0.1; far:5000"
        look-controls="enabled:true; magicWindowTrackingEnabled:true; touchEnabled:true"
        wasd-controls="enabled:false">
      </a-entity>
    </a-entity>

    <!-- CIEL + REPÈRES VISUELS POUR VOIR LE GYRO -->
    <a-sky color="#001022"></a-sky>

    <!-- Anneau “horizon” -->
    <a-ring position="0 0 -12" rotation="90 0 0" radius-inner="4.9" radius-outer="5.1"
            material="color:#00ffcc; opacity:0.35; transparent:true; emissive:#00ffcc; emissiveIntensity:0.4"></a-ring>

    <!-- Axes (repère) -->
    <a-entity position="0 0 -12">
      <a-box position="3 0 0" width="6" height="0.04" depth="0.04" material="color:#ff4444; emissive:#ff4444; emissiveIntensity:0.6"></a-box>
      <a-box position="0 3 0" width="0.04" height="6" depth="0.04" material="color:#44ff44; emissive:#44ff44; emissiveIntensity:0.6"></a-box>
      <a-box position="0 0 3" width="0.04" height="0.04" depth="6" material="color:#4488ff; emissive:#4488ff; emissiveIntensity:0.6"></a-box>
    </a-entity>

    <a-entity id="celestial-layer"></a-entity>
    <a-light type="ambient" intensity="0.9"></a-light>
  </a-scene>

  <script>
    const starData = [
      { name: "Sirius", ra: 6.75, dec: -16.71, dist: 8.6 },
      { name: "Vega", ra: 18.61, dec: 38.78, dist: 25.0 },
      { name: "Betelgeuse", ra: 5.92, dec: 7.41, dist: 642.5 },
      { name: "Polaris", ra: 2.53, dec: 89.26, dist: 431.4 },
      { name: "Alpha Centauri", ra: 14.66, dec: -60.83, dist: 4.37 },
      { name: "Rigel", ra: 5.24, dec: -8.20, dist: 863.0 }
    ];

    let userCoords = null;
    let selectedObject = null;
    const planets = ["Sun", "Moon", "Mars", "Jupiter", "Saturn", "Venus"];

    // --- Service worker ---
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("sw.js").catch(err => console.log("SW non enregistré", err));
      });
    }

    // --- UI events ---
    window.addEventListener("DOMContentLoaded", () => {
      document.getElementById("btn-calibrate").addEventListener("click", () => {
        requestPermissionsAndCalibrate();
      });

      document.getElementById("target-select").addEventListener("change", (e) => {
        updateTarget(e.target.value);
      });
    });

    // --- GPS ---
    navigator.geolocation.getCurrentPosition(
      pos => {
        userCoords = pos.coords;
        document.getElementById("pos-info").innerText =
          `LAT: ${userCoords.latitude.toFixed(4)} | LON: ${userCoords.longitude.toFixed(4)}`;
        initApp();
      },
      err => {
        console.log("Erreur GPS", err);
        document.getElementById("pos-info").innerText = "Erreur GPS : Accès refusé.";
      },
      { enableHighAccuracy: true, maximumAge: 5000, timeout: 10000 }
    );

    function initApp() {
      const pList = document.getElementById("planets-list");
      const sList = document.getElementById("stars-list");
      pList.innerHTML = "";
      sList.innerHTML = "";
      planets.forEach(p => pList.innerHTML += `<option value="${p}">${p}</option>`);
      starData.forEach(s => sList.innerHTML += `<option value="${s.name}">${s.name}</option>`);

      refreshPositions();
      setInterval(refreshPositions, 1000);
    }

    function refreshPositions() {
      if (!userCoords) return;

      const container = document.getElementById("celestial-layer");
      container.innerHTML = "";

      const obs = new Astronomy.Observer(userCoords.latitude, userCoords.longitude, 0);
      const now = new Date();

      planets.forEach(name => {
        const eq = Astronomy.Equator(name, now, obs, true, true);
        const horiz = Astronomy.Horizon(now, obs, eq.ra, eq.dec, "refray");
        renderMarker(name, horiz, true);

        if (selectedObject === name) {
          const dKm = eq.dist * 149597870.7; // AU -> km
          updateHUD(name, dKm, "km");
        }
      });

      starData.forEach(star => {
        const horiz = Astronomy.Horizon(now, obs, star.ra, star.dec, "refray");
        renderMarker(star.name, horiz, false);

        if (selectedObject === star.name) {
          updateHUD(star.name, star.dist, "AL");
        }
      });
    }

    function renderMarker(name, horiz, isPlanet) {
      if (horiz.altitude < -20) return;

      const pos = azAltToCartesian(horiz.azimuth, horiz.altitude, 50);

      const el = document.createElement("a-entity");
      el.setAttribute("position", pos);

      const dot = document.createElement("a-sphere");
      dot.setAttribute("radius", isPlanet ? "0.7" : "0.25");
      dot.setAttribute("material",
        `color:${isPlanet ? "#00ffcc" : "#ffffff"};
         emissive:${isPlanet ? "#00ffcc" : "#ffffff"};
         emissiveIntensity:0.6;
         opacity:${horiz.altitude > 0 ? 1 : 0.3};
         transparent:true;`
      );

      el.appendChild(dot);
      document.getElementById("celestial-layer").appendChild(el);
    }

    function updateHUD(name, val, unit) {
      const hud = document.getElementById("distance-hud");
      hud.style.display = "block";
      document.getElementById("hud-name").innerText = name;

      if (unit === "km") {
        document.getElementById("hud-dist").innerText = Math.round(val).toLocaleString("fr-FR");
        document.getElementById("hud-unit").innerText = "Kilomètres de la Terre";
      } else {
        document.getElementById("hud-dist").innerText = Number(val).toFixed(1).toLocaleString("fr-FR");
        document.getElementById("hud-unit").innerText = "Années-Lumière de la Terre";
      }
    }

    function updateTarget(val) {
      selectedObject = val;
      if (!val) document.getElementById("distance-hud").style.display = "none";
      refreshPositions();
    }

    function azAltToCartesian(az, alt, radius) {
      const phi = (90 - alt) * (Math.PI / 180);
      const theta = (az + 180) * (Math.PI / 180);
      return `${radius * Math.sin(phi) * Math.cos(theta)} ${radius * Math.cos(phi)} ${radius * Math.sin(phi) * Math.sin(theta)}`;
    }

    // --- CALIBRATION ANDROID (pas de prompt, mais on force une relance) ---
    function requestPermissionsAndCalibrate() {
      const btn = document.getElementById("btn-calibrate");
      const cam = document.getElementById("camera");

      // 1) Reset rotation
      cam.setAttribute("rotation", "0 0 0");

      // 2) Relancer look-controls si possible
      const lc = cam.components && cam.components["look-controls"];
      if (lc) {
        try {
          // Certains devices gardent un état interne : on le remet à zéro
          if (lc.yawObject) lc.yawObject.rotation.y = 0;
          if (lc.pitchObject) lc.pitchObject.rotation.x = 0;

          // Redémarre l'écoute
          if (typeof lc.pause === "function") lc.pause();
          if (typeof lc.play === "function") lc.play();
        } catch (e) {
          console.log("Reset look-controls error:", e);
        }
      }

      // 3) Test : est-ce qu'on reçoit des events capteurs ?
      let gotEvent = false;
      const handler = (e) => {
        gotEvent = true;
        window.removeEventListener("deviceorientation", handler);
        setCalibrateSuccess(btn, true);
      };
      window.addEventListener("deviceorientation", handler, { once: true });

      setTimeout(() => {
        if (!gotEvent) {
          // Le gyro peut être désactivé au niveau du téléphone / navigateur
          setCalibrateSuccess(btn, false);
        }
      }, 1200);
    }

    function setCalibrateSuccess(btn, sensorOk) {
      btn.classList.add("success");
      btn.innerText = sensorOk ? "CAPTEURS OK" : "GYRO OFF ?";
      if (!sensorOk) {
        // message utile sans bloquer
        console.log("Aucun event deviceorientation reçu. Vérifie : capteurs autorisés, économie d'énergie, navigateur, etc.");
      }
    }
  </script>
</body>
</html>
