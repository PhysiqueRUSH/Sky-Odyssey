<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Sky Odyssey</title>

  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/png" href="skyico.png" />
  <meta name="theme-color" content="#000510" />

  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js"></script>

  <style>
    /* IMPORTANT : donner une hauteur réelle au document */
    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      background: #000;
      overflow: hidden;
      font-family: "Segoe UI", sans-serif;
    }

    /* IMPORTANT : forcer A-Frame en plein écran (sinon embedded peut faire 0px) */
    a-scene {
      position: fixed !important;
      inset: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      z-index: 1 !important;
      background: #020816; /* au cas où */
    }
    canvas { width: 100% !important; height: 100% !important; }

    /* UI au-dessus */
    #ui-layer {
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      z-index: 9999;
      padding: 20px;
      box-sizing: border-box;
      background: linear-gradient(to bottom, rgba(0, 5, 15, 0.95), transparent);
      color: #00ffcc;
      pointer-events: auto;
    }

    #pos-info {
      font-family: monospace;
      font-size: 12px;
      color: #88ccff;
      opacity: 0.9;
    }

    select, button {
      background: #001a2b;
      color: #00ffcc;
      border: 1px solid #00ffcc;
      padding: 10px 12px;
      border-radius: 6px;
      font-size: 14px;
      outline: none;
    }

    button.success {
      background: #00ffcc;
      color: #001a2b;
      border-color: #fff;
      font-weight: bold;
    }

    /* Mini debug en bas */
    #debug {
      position: fixed;
      bottom: 10px;
      left: 10px;
      z-index: 9999;
      color: #fff;
      font-family: monospace;
      font-size: 12px;
      background: rgba(0,0,0,0.45);
      padding: 8px 10px;
      border-radius: 8px;
      max-width: 95vw;
      pointer-events: none;
      white-space: pre-line;
    }
  </style>
</head>

<body>
  <div id="ui-layer">
    <strong style="letter-spacing:2px;">SKY ODYSSEY</strong><br>
    <span id="pos-info">GPS…</span>
    <br><br>
    <div style="display:flex; gap:12px; flex-wrap:wrap;">
      <select id="target-select">
        <option value="">-- Sélectionner Cible --</option>
        <optgroup label="Système Solaire" id="planets-list"></optgroup>
        <optgroup label="Étoiles Majeures" id="stars-list"></optgroup>
      </select>

      <button id="btn-calibrate">Calibrer Gyro</button>
    </div>
  </div>

  <div id="debug">Debug…</div>

  <!-- NOTE : embedded OK, mais on force le plein écran via CSS -->
  <a-scene embedded vr-mode-ui="enabled:false" renderer="antialias:true; precision:mediump">
    <!-- Caméra -->
    <a-entity id="cameraRig">
      <a-entity
        id="camera"
        camera="near:0.1; far:2000"
        position="0 1.6 0"
        look-controls="enabled:true; magicWindowTrackingEnabled:true"
        wasd-controls="enabled:false">
      </a-entity>
    </a-entity>

    <!-- Fond visible -->
    <a-sky color="#07152e"></a-sky>

    <!-- REPÈRES GÉANTS (si tu ne vois pas ça, la scène ne s'affiche pas du tout) -->
    <a-plane rotation="-90 0 0" width="60" height="60"
             material="color:#0b2545; opacity:0.9; transparent:true"></a-plane>

    <a-box position="0 2 -6" depth="1" height="1" width="1"
           material="color:#00ffcc; emissive:#00ffcc; emissiveIntensity:0.7"></a-box>

    <a-text value="SI TU VOIS CE TEXTE, A-FRAME FONCTIONNE"
            position="-4 3 -6" width="14"
            color="#ffffff"></a-text>

    <!-- Couche des astres -->
    <a-entity id="celestial-layer"></a-entity>

    <a-light type="ambient" intensity="1.0"></a-light>
  </a-scene>

  <script>
    const debugEl = document.getElementById("debug");
    function debug(msg) { debugEl.textContent = msg; }

    // Données
    const starData = [
      { name: "Sirius", ra: 6.75, dec: -16.71, dist: 8.6 },
      { name: "Vega", ra: 18.61, dec: 38.78, dist: 25.0 },
      { name: "Betelgeuse", ra: 5.92, dec: 7.41, dist: 642.5 },
      { name: "Polaris", ra: 2.53, dec: 89.26, dist: 431.4 },
      { name: "Alpha Centauri", ra: 14.66, dec: -60.83, dist: 4.37 },
      { name: "Rigel", ra: 5.24, dec: -8.20, dist: 863.0 }
    ];
    const planets = ["Sun", "Moon", "Mars", "Jupiter", "Saturn", "Venus"];

    let userCoords = null;
    let selectedObject = null;

    // UI events
    document.getElementById("btn-calibrate").addEventListener("click", () => {
      const btn = document.getElementById("btn-calibrate");
      btn.classList.add("success");
      btn.textContent = "CAPTEURS OK";

      // Test capteurs (sur Android parfois désactivé)
      let got = false;
      const handler = () => { got = true; window.removeEventListener("deviceorientation", handler); };
      window.addEventListener("deviceorientation", handler, { once: true });
      setTimeout(() => {
        debug(
          "Scene: OK (repères affichés)\n" +
          "GPS: " + (userCoords ? "OK" : "en attente") + "\n" +
          "Gyro events: " + (got ? "OK" : "NON (peut être désactivé)") + "\n" +
          "Sélection: " + (selectedObject || "aucune")
        );
      }, 800);
    });

    document.getElementById("target-select").addEventListener("change", (e) => {
      selectedObject = e.target.value || null;
      refreshPositions();
    });

    // Remplir listes
    const pList = document.getElementById("planets-list");
    const sList = document.getElementById("stars-list");
    planets.forEach(p => pList.innerHTML += `<option value="${p}">${p}</option>`);
    starData.forEach(s => sList.innerHTML += `<option value="${s.name}">${s.name}</option>`);

    // GPS
    navigator.geolocation.getCurrentPosition(
      pos => {
        userCoords = pos.coords;
        document.getElementById("pos-info").textContent =
          `LAT: ${userCoords.latitude.toFixed(4)} | LON: ${userCoords.longitude.toFixed(4)}`;
        debug("Scene: OK (repères)\nGPS: OK\nChoisis un objet dans la liste.");
        refreshPositions();
        setInterval(refreshPositions, 1500);
      },
      err => {
        document.getElementById("pos-info").textContent = "GPS refusé / erreur";
        debug("Scene: OK (repères)\nGPS: NON\nAutorise la localisation.");
        console.log(err);
      },
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 5000 }
    );

    function refreshPositions() {
      if (!userCoords) return;

      const container = document.getElementById("celestial-layer");
      container.innerHTML = "";

      const obs = new Astronomy.Observer(userCoords.latitude, userCoords.longitude, 0);
      const now = new Date();

      // Planètes
      planets.forEach(name => {
        try {
          const eq = Astronomy.Equator(name, now, obs, true, true);
          const horiz = Astronomy.Horizon(now, obs, eq.ra, eq.dec, "refray");

          // IMPORTANT: on rend visible même proche horizon pour debug
          renderMarker(name, horiz, true);

        } catch (e) {
          console.log("Planet error", name, e);
        }
      });

      // Étoiles
      starData.forEach(star => {
        try {
          const horiz = Astronomy.Horizon(now, obs, star.ra, star.dec, "refray");
          renderMarker(star.name, horiz, false);
        } catch (e) {
          console.log("Star error", star.name, e);
        }
      });
    }

    function renderMarker(name, horiz, isPlanet) {
      // NE PAS filtrer trop fort tant que tu testes
      // if (horiz.altitude < -20) return;

      // Plus proche + plus gros = visible
      const pos = azAltToCartesian(horiz.azimuth, Math.max(horiz.altitude, -5), 10);

      const el = document.createElement("a-entity");
      el.setAttribute("position", pos);

      const dot = document.createElement("a-sphere");
      dot.setAttribute("radius", isPlanet ? "0.9" : "0.6");
      dot.setAttribute("material",
        `color:${isPlanet ? "#00ffcc" : "#ffffff"};
         emissive:${isPlanet ? "#00ffcc" : "#ffffff"};
         emissiveIntensity:1.0;
         opacity:1;
         transparent:true;`
      );

      el.appendChild(dot);

      // Petit label visible
      const label = document.createElement("a-text");
      label.setAttribute("value", name);
      label.setAttribute("color", "#ffffff");
      label.setAttribute("width", "8");
      label.setAttribute("position", "0 1.0 0");
      el.appendChild(label);

      document.getElementById("celestial-layer").appendChild(el);
    }

    function azAltToCartesian(az, alt, radius) {
      const phi = (90 - alt) * (Math.PI / 180);
      const theta = (az + 180) * (Math.PI / 180);
      return `${radius * Math.sin(phi) * Math.cos(theta)} ${radius * Math.cos(phi)} ${radius * Math.sin(phi) * Math.sin(theta)}`;
    }
  </script>
</body>
</html>
